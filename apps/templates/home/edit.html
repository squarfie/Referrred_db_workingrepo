{% extends 'layouts/base.html' %}

{% load widget_tweaks %}
{% load custom_filters %}

{% block title %} Demographic Data {% endblock title %}

{% block content %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}

<!-- style for back to top button -->
<style>
#myBtn {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 30px;
  z-index: 99;
  font-size: 12px;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 10px;
  border-radius: 4px;
  height: 50px;
  
}

#myform{
  font-size: small;
}

label.form-control-label{
  font-size: small;
}

.fontsize{
  font-size: large;
  color: blue;
  font-weight: bold;
}

.fontlarge{
  font-size: large;
}
</style>
{% endblock stylesheets %}



<div class="header pb-6 d-flex align-items-center" 
     style="min-height: 200px; background-size: auto; background-image: url(/static/assets/img/theme/microbial.jpg); background-size: cover; background-position: center top;">
  <!-- Mask -->
  <span class="mask bg-gradient-default opacity-4"></span>
  <!-- Header container -->
  <div class="container-fluid d-flex flex-column align-items-right">
    <div class="row">
      <div class="col-lg-10 col-md-4">
        <!-- <h6 class="display-2 text-white align=text-right"> 
          Hello {{ request.user.username }}
        </h6>
        <p class="text-white mt-0 mb-5"></p> --> 
        <!-- <a href="#" class="btn btn-neutral">Filter</a> -->
        <!-- <div class="row">
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }}" style="background: rgba(0, 0, 0, 0); color: white; border: none;">
                {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        </div> -->
        
        <br><br>
      </div>
    </div>
  </div>
</div>
<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
 
<!-- DEMOGRAPHIC DATA -->

    <div class="col-xl-12 order-xl-1">
      <form method="POST" 
      action="{% if isolates %}{% url 'edit_data' isolates.id %}{% endif %}" 
      autocomplete="on" id="myform">
        {% csrf_token %}
      <div class="card" >
        <div class="card-header" id="mytop">
          <div class="row align-items-center">
            <!-- <div class="col-8">
               <h3 class="mb-0">SURVEILLANCE SITE INFORMATION </h3> 
            </div> -->
            <div class="col-12">
              <div class="row">
                <div class="col-lg-2">
                  <div class="form-group" >
                      <label class="form-control-label" for="SiteCode">SITE CODE</label>
                      <div class="d-flex align-items-center">
                      {{ form.SiteCode| append_attr:"class: form-control "}} 
                      </div>
                  </div>
                </div>
                <div class="col-lg-2">
                  <div class="form-group" >
                  <label class="form-control-label" for=" Referral_Date">Referral Date</label>
                  {{form.Referral_Date| append_attr:"class: form-control " }}
                  </div>
                </div>
               <div class="col-lg-2">
                  <div class="form-group" >
                  <label class="form-control-label" for="BatchNo">Batch No</label>
                  {{form.BatchNo| append_attr:"class: form-control " }}
                  </div>
                </div>
                <div class="col-lg-2">
                  <div class="form-group" >
                  <label class="form-control-label" for="RefNo">Reference No</label>
                  {{form.RefNo| append_attr:"class: form-control " }}
                  </div>
                </div>
              <div class="col-4 text-right">
                <a href="{% url 'batch_create_view' %}" class="btn btn-sm btn-primary">Add New</a>
                <button type="submit" class="btn btn-sm btn-primary">Save</button>
                <a href="{% url 'show_data' %}" class="btn btn-sm btn-primary">View / Print</a>  
                <a href="{% url 'add_breakpoints' %}" class="btn btn-warning btn-sm">Breakpoints</a>
              </div>
              </div>
             
           
<br>
                   
            <div class="row">
                  <div class="col-lg-5">
                  <div class="form-group">
                    <label class='form-control-label' for='Site_Name'>Site Name</label>
                    {{form.Site_Name| append_attr:"class: form-control fontsize"}}
                  </div>
                  </div>
                <div class="col-lg-4">
                <div class="form-group">
                  <label class="form-control-label" for="AccessionNo">Accession Number</label>
                  {{form.AccessionNo| append_attr:"class: form-control fontsize"}} 
              </div>
              </div>
              <div class="col-lg-3">
                <div class="form-group">
                  <label class='form-control-label' for='Batch_Code'>Batch Code</label>
                  {{form.Batch_Code| append_attr:"class: form-control fontsize"}}
                </div>
              </div>
          
           
          
          </div>
       
        </div>
    
      </div> <!--mother tab content-->
     <ul class="nav nav-tabs card-header-tabs" role="tablist"> 
        <li class="nav-item">
          <button class="nav-link active" href="#tabcontent1"  id="tab1" data-toggle="tab" role="tab">SENTINEL SITE DATA</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" href="#tabcontent2" id="tab2"  data-toggle="tab" role="tab" >ARSRL STY RESULTS</button>
        </li>
    </ul>
        <div class="card-body">
 
          <div class="tab-content">
            <div class="tab-pane fade show active" id="tabcontent1" role="tabpanel" aria-labelledby="tab1">
           <br>
           
           <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">PATIENT INFORMATION</h6>
           <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">

              <div class="row">
                <div class="col-lg-3">
                  <div class="form-group">
                    <label class="form-control-label" for="Patient_ID">Patient No</label>
                    {{form.Patient_ID| append_attr:"class: form-control"}}
                 
                  </div>
                </div>
                <div class="col-lg-3">
                  <div class="form-group">
                    <label class="form-control-label" for="First_Name">First Name</label>
                    {{form.First_Name|append_attr:"class: form-control"}}
                  </div>
                </div>
                <div class="col-lg-3">
                  <div class="form-group">
                    <label class="form-control-label" for="Mid_Name">Middle Name</label>
                    {{form.Mid_Name| append_attr:"class: form-control"}}
                  </div>
                </div>
                <div class="col-lg-3">
                  <div class="form-group">
                    <label class='form-control-label' for='Last_Name'>Last Name</label> 
                   {{form.Last_Name|append_attr:"class: form-control"}}
                  </div>
                </div>
              </div>
          <div class="row">
              <div class="col-lg-3">
                <div class="form-group">
                  <label class='form-control-label' for='Date_Birth'>Date of Birth</label>
                  {{form.Date_Birth| append_attr:"class: form-control"}}
                </div>
              </div>
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Age'>Age</label> {{form.Age| append_attr:"class: form-control"}}
                </div>
              </div>
                <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Sex'>Sex</label> {{form.Sex| append_attr:"class: form-control"}}
                </div>
              </div>
              <div class="col-lg-3">
                <div class="form-group">
                  <label class='form-control-label' for='Date_Admis'>Date of Admission</label> {{form.Date_Admis| append_attr:"class: form-control"}}
                </div>
              </div>
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Nosocomial'>Nosocomial</label> {{form.Nosocomial | append_attr:"class: form-control" }}
                </div>
              </div>
        </div>

          <div class="row">
            <div class="col-lg-3">
              <div class="form-group">
                <label class='form-control-label' for='Diagnosis'>Diagnosis</label> {{form.Diagnosis| append_attr:"class: form-control" }}
              </div>
            </div>
            <div class="col-lg-3">
              <div class="form-group">
                <label class='form-control-label' for='Diagnosis_ICD10'>ICD-10</label> {{form.Diagnosis_ICD10| append_attr:"class: form-control" }}
              </div>
            </div>
            <div class="col-lg-3">
              <div class="form-group">
                <label class='form-control-label' for='Ward'>Ward</label> {{form.Ward| append_attr:"class: form-control" }}
              </div>
            </div>
            <div class="col-lg-3">
              <div class="form-group">
                <label class='form-control-label' for='Service_Type'>Service Type</label> {{form.Service_Type| append_attr:"class: form-control" }}
              </div>
            </div>
           
          </div>

          <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">ISOLATE INFORMATION</h6>
           <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">
            <div class="row">
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Spec_Num'>Specimen No</label> {{form.Spec_Num | append_attr:"class: form-control" }}
                </div>
              </div>
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Spec_Date'>Specimen Date</label> {{form.Spec_Date| append_attr:"class: form-control" }}
                </div>
              </div>
                  <div class="col-lg-2">
                              <div class="form-group">
                                <label class="form-control-label" for="Spec_Type">Specimen Type <span><a href="{% url 'add_specimen' %}" class="col-4 shortcut-item" style="padding: 0;">
                                  <span class="ni ni-settings" style="margin-left: 10px; line-height: 0; vertical-align: middle;"></span>
                                  </a></span></label> {{form.Spec_Type| append_attr:"class: form-control"}}
                                <div class="d-flex align-items-left">
                                </div>
                              </div>
                            </div>
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Reason'>Reason for referral</label> {{form.Reason| append_attr:"class: form-control" }}
                </div>
              </div>
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Growth'>Growth</label> {{form.Growth| append_attr:"class: form-control" }}
                </div>
              </div>
              <div class="col-lg-2">
                <div class="form-group">
                  <label class='form-control-label' for='Urine_ColCt'>Urine Col ct</label> {{form.Urine_ColCt| append_attr:"class: form-control" }}
                </div>
              </div>

            </div>

            
          
  

<!-- PHENOTYPIC RESULTS -->
          
            <!-- Address -->
            <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">PHENOTYPIC RESULTS</h6>
            <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">

            <div class="pl-lg-12">
              <!-- <div class="row">
                <div class="col-md-12">
                  <div class="form-group">
                    <label class="form-control-label" for="input-address">Address</label>
                    <input id="input-address" class="form-control" placeholder="Home Address" value="Bld Mihail Kogalniceanu, nr. 8 Bl 1, Sc 1, Ap 09" type="text">
                  </div>
                </div>
              </div> -->
              <div class="row">
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='ampC'>ampC</label> {{form.ampC | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='ESBL'>ESBL</label> {{form.ESBL | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='CARB'>CARB</label> {{form.CARB | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='MBL'>MBL</label> {{form.MBL | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='BL'>BL</label> {{form.BL | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='MR'>MR</label> {{form.MR | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='mecA'>mecA</label> {{form.mecA | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-1">
                  <div class="form-group">
                    <label class='form-control-label' for='ICR'>ICR</label> {{form.ICR | append_attr:"class: form-control" }}
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group">
                    <label class='form-control-label' for='OtherResMech'>Other</label> {{form.OtherResMech | append_attr:"class: form-control" }}
                  </div>
                </div>

              </div>
        
            <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">ORGANISM RESULTS</h6>
            <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">

                        <div class="pl-lg-12">
  
                          <div class="row">
                             <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='Site_Pre'>Site Pre</label> {{form.Site_Pre| append_attr:"class: form-control" }}
                              </div>
                            </div>
                               <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='OrganismCode'>Organism Code</label> {{form.OrganismCode| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='Site_Org'>Organism Name</label> {{form.Site_Org| append_attr:"class: form-control" }}
                              </div>
                            </div>
                         
                            <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='Site_Pos'>Site Post</label> {{form.Site_Pos| append_attr:"class: form-control" }}
                              </div>
                            </div>
                          </div>
                          </div>
           

      
        <!--MEDICAL HISTORY-->
        <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">ANTIMICROBIAL SUSCEPTIBILITY TEST RESULTS</h6>
        <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">
            <div class="pl-lg-12">
                <div class="row"> 

<div class="col-lg-12">
  <div class="row">

    <!-- 🧫 DISK DIFFUSION -->
    <div class="col-lg-5">
      <table class="table align-items-center text-center table-sm table-responsive" style="padding: 1em; border-width: 0; border-collapse: collapse; width: 100%;">
        <thead class="thead-light" style="text-align: center;">
          <tr style="line-height: 15px;">
            <th scope="col" style="width: 90px;">ANTIBIOTIC</th>
            <th scope="col" style="width: 90px;">WHONET CODE</th>
            <th scope="col" style="width: 98px;">TEST METHOD</th>
            <th scope="col" style="width: 98px;">RESULT</th>
            <th scope="col" style="width: 98px;">RIS</th>
          </tr>
        </thead>
        <tbody>
          {% if whonet_abx_data %}
            {% for entry in whonet_abx_data|dictsort:"Whonet_Abx" %}
              {% if entry.Disk_Abx %}
                <tr>
                  <td>{{ entry.Antibiotic }}</td>
                  <td>{{ entry.Whonet_Abx }}</td>
                  <td>DISK</td>
                  <td>
                    <input name="disk_{{ entry.Whonet_Abx }}" 
                           value="{% get_existing_value existing_entries entry.Whonet_Abx 'disk' %}" 
                           type="number" min="0" style="width: 70px;">
                  </td>
                  <td>
                    <input name="disk_enris_{{ entry.Whonet_Abx }}"
                           value="{% get_existing_value existing_entries entry.Whonet_Abx 'disk_enris' %}"
                           type="text" style="width: 50px;">
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% else %}
            <tr><td colspan="5">No antibiotics available for Disk Diffusion</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- 💧 MIC RESULTS -->
    <div class="col-lg-7">
      <table class="table align-items-center text-center table-sm table-responsive" style="padding: 1em; border-width: 0; border-collapse: collapse; width: 100%;">
        <thead class="thead-light" style="text-align: center;">
          <tr style="line-height: 15px;">
            <th scope="col" style="width: 90px;">ANTIBIOTIC</th>
            <th scope="col" style="width: 90px;">WHONET CODE</th>
            <th scope="col" style="width: 98px;">TEST METHOD</th>
            <th scope="col" style="width: 98px;">Operand</th>
            <th scope="col" style="width: 98px;">RESULT</th>
            <th scope="col" style="width: 98px;">RIS</th>
            <th scope="col" style="width: 98px;">Alert MIC</th>
          </tr>
        </thead>
        <tbody>
          {% if whonet_abx_data %}
            {% for entry in whonet_abx_data|dictsort:"Whonet_Abx" %}
              {% if not entry.Disk_Abx %}
                <tr>
                  <td>{{ entry.Antibiotic }}</td>
                  <td>{{ entry.Whonet_Abx }}</td>
                  <td>MIC</td>
                  <td>
                    <input type="text" name="mic_operand_{{ entry.Whonet_Abx }}" 
                           value="{% get_existing_value existing_entries entry.Whonet_Abx 'mic_operand' %}"
                           style="width: 50px;">
                  </td>
                  <td>
                    <input name="mic_{{ entry.Whonet_Abx }}" 
                           value="{% get_existing_value existing_entries entry.Whonet_Abx 'mic' %}" 
                           type="number" min="0" step="0.001" style="width: 70px;">
                  </td>
                  <td>
                    <input name="mic_enris_{{ entry.Whonet_Abx }}"
                           value="{% get_existing_value existing_entries entry.Whonet_Abx 'mic_enris' %}"
                           type="text" style="width: 50px;">
                  </td>
                  <td>
                    {% get_existing_value existing_entries entry.Whonet_Abx 'alert_mic' as alert_mic_checked %}
                    <input type="checkbox" 
                           name="alert_mic_{{ entry.Whonet_Abx }}"
                           style="transform: scale(1.5); margin: 4px;"
                           {% if alert_mic_checked %}checked{% endif %}>
                  </td>
                </tr>
              {% endif %}
            {% endfor %}
          {% else %}
            <tr><td colspan="7">No antibiotics available for MIC results</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </div>
</div>

          </div> 
                <!-- end of table for antibiotics -->

                <div class="row">
                  <div class="col-lg-12">
                              <div class="form-group">
                                <label class='form-control-label' for='Comments'>Commments</label> {{form.Comments| append_attr:"class: form-control" }}
                              </div>
                        </div>
                </div>
              </div>
            </div>
          </div> 
                <!-- end of first tab -->
   
                <!--LABORATORY RESULTS-->
                <div class="tab-pane fade" id="tabcontent2" role="tabpanel" aria-labelledby="tab2" >
                  <br>
                  <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">ORGANISM INFORMATION</h6>
                  <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">
                  <div class="pl-lg-12">
                          <div class="row">
                            
                            <div class="col-lg-2">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_ampC'>ampC</label> {{form.ars_ampC| append_attr:"class: form-control" }}
                              </div>
                            </div>
                           <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_ESBL'>ESBL</label> {{form.ars_ESBL| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_CARB'>CARB</label> {{form.ars_CARB| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_ECIM'>ECIM</label> {{form.ars_ECIM| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_MCIM'>MCIM</label> {{form.ars_MCIM| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_EC_MCIM'>EC MCIM</label> {{form.ars_EC_MCIM| append_attr:"class: form-control" }}
                              </div>
                            </div>
                             <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_MBL'>MBL</label> {{form.ars_MBL| append_attr:"class: form-control" }}
                              </div>
                            </div>
                             <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_BL'>BL</label> {{form.ars_BL| append_attr:"class: form-control" }}
                              </div>
                            </div>
                             <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_MR'>MR</label> {{form.ars_MR| append_attr:"class: form-control" }}
                              </div>
                            </div>
                             <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_mecA'>mecA</label> {{form.ars_mecA| append_attr:"class: form-control" }}
                              </div>
                            </div>
                             <div class="col-lg-1">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_ICR'>ICR</label> {{form.ars_ICR| append_attr:"class: form-control" }}
                              </div>
                            </div>
                          </div>

                          <div class="row">
                             <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_Pre'>ARSRL Pre</label> {{form.ars_Pre| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_OrgCode'>Organism Code</label> {{form.ars_OrgCode| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_OrgName'>Organism Name</label> {{form.ars_OrgName| append_attr:"class: form-control" }}
                              </div>
                            </div>
                            <div class="col-lg-3">
                              <div class="form-group">
                                <label class='form-control-label' for='ars_Post'>ARSRL Post</label> {{form.ars_Post| append_attr:"class: form-control" }}
                              </div>
                            </div>
                          </div>
               <div class="pl-lg-12">
              <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">ANTIMICROBIAL SUSCEPTIBILITY TEST RESULTS</h6>
              <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">
              </div>


<div class="col-lg-12">
  <div class="row">

    <!-- 🧫 RETEST DISK DIFFUSION -->
    <div class="col-lg-5">
      <h6 class="heading-small text-muted mb-4">RETEST — DISK DIFFUSION</h6>
      <div class="card border-info mb-3">
        <div class="card-body text-info">
          <div class="row">
            <div class="col-lg-12">
              <table class="table align-items-center text-center table-sm table-responsive"
                     style="padding: 1em; border-width: 0; border-collapse: collapse; width: 100%;">
                <thead class="thead-light" style="text-align: center;">
                  <tr style="line-height: 15px;">
                    <th scope="col">ANTIBIOTIC</th>
                    <th scope="col">TEST METHOD</th>
                    <th scope="col">WHONET CODE</th>
                    <th scope="col">TEST RESULT</th>
                    <th scope="col">RIS</th>
                  </tr>
                </thead>
                <tbody>
                  {% if whonet_retest_data %}
                    {% for retest in whonet_retest_data|dictsort:"Whonet_Abx" %}
                      {% if retest.Disk_Abx %}
                        <tr>
                          <td>{{ retest.Antibiotic }}</td>
                          <td>DISK</td>
                          <td>{{ retest.Whonet_Abx }}</td>
                          <td>
                            <input name="retest_disk_{{ retest.Whonet_Abx }}"
                                   value="{% get_existing_value retest_entries retest.Whonet_Abx 'retest_disk' %}"
                                   type="number" min="0" style="width: 50px;">
                          </td>
                          <td>
                            <input name="retest_disk_enris_{{ retest.Whonet_Abx }}"
                                   value="{% get_existing_value retest_entries retest.Whonet_Abx 'retest_disk_enris' %}"
                                   type="text" style="width: 50px;">
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="5">No retest antibiotics for Disk Diffusion</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 💧 RETEST MIC RESULTS -->
    <div class="col-lg-7">
      <h6 class="heading-small text-muted mb-4">RETEST — MIC RESULTS</h6>
      <div class="card border-info mb-3">
        <div class="card-body text-info">
          <div class="row">
            <div class="col-lg-12">
              <table class="table align-items-center text-center table-sm table-responsive"
                     style="padding: 1em; border-width: 0; border-collapse: collapse; width: 100%;">
                <thead class="thead-light" style="text-align: center;">
                  <tr style="line-height: 15px;">
                    <th scope="col">ANTIBIOTIC</th>
                    <th scope="col">TEST METHOD</th>
                    <th scope="col">WHONET CODE</th>
                    <th scope="col">Operand</th>
                    <th scope="col">TEST RESULT</th>
                    <th scope="col">RIS</th>
                    <th scope="col" style="width: 98px;">Alert MIC</th>
                  </tr>
                </thead>
                <tbody>
                  {% if whonet_retest_data %}
                    {% for retest in whonet_retest_data|dictsort:"Whonet_Abx" %}
                      {% if not retest.Disk_Abx %}
                        <tr>
                          <td>{{ retest.Antibiotic }}</td>
                          <td>MIC</td>
                          <td>{{ retest.Whonet_Abx }}</td>
                          <td>
                            <input name="retest_mic_operand_{{ retest.Whonet_Abx }}"
                                   value="{% get_existing_value retest_entries retest.Whonet_Abx 'retest_mic_operand' %}"
                                   type="text" style="width: 50px;">
                          </td>
                          <td>
                            <input name="retest_mic_{{ retest.Whonet_Abx }}"
                                   value="{% get_existing_value retest_entries retest.Whonet_Abx 'retest_mic' %}"
                                   type="number" min="0" step="0.001" style="width: 50px;">
                          </td>
                          <td>
                            <input name="retest_mic_enris_{{ retest.Whonet_Abx }}"
                                   value="{% get_existing_value retest_entries retest.Whonet_Abx 'retest_mic_enris' %}"
                                   type="text" style="width: 50px;">
                          </td>
                          <td>
                            {% get_existing_value retest_entries retest.Whonet_Abx 'retest_alert_mic' as retest_alert_mic_checked %}
                            <input type="checkbox"
                                   name="retest_alert_mic_{{ retest.Whonet_Abx }}"
                                   style="transform: scale(1.5); margin: 4px;"
                                   {% if retest_alert_mic_checked %}checked{% endif %}>
                          </td>
                        </tr>
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <tr><td colspan="7">No retest antibiotics for MIC results</td></tr>
                  {% endif %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

            <div class="pl-lg-12">
              <h6 class="heading-small mb-0" style="padding-bottom: 0; margin-bottom: 0;">LABORATORY PERSONNEL PROVIDING INFORMATION</h6>
              <hr class="border border-primary border-3 opacity-75 " style="margin-top: 0; padding-top: 0%;">
              </div>
            <div class="row">
            
              <div class="col-lg-12">

                <div class="card border-info mb-3">
                  <div class="card-body  text-info">
                    <div class="col-lg-12">
                      <div class="row">
                        <div class="col-lg-4">
                          <div class="form-group">                    
                            <label class='form-control-label' for='Laboratory_Staff'>Laboratory Staff</label>
                            <div class="d-flex align-items-center">
                              {{ form.Laboratory_Staff| append_attr:"class: form-control "}} 
                              <span><a href="{% url 'add_contact' %}" class="col-4 shortcut-item" style="padding: 0;">
                              <span class="ni ni-settings" style="margin-left: 10px; line-height: 0; vertical-align: text-bottom;"></span>
                              </a></span>
                              </div>
                          </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                              <label class='form-control-label' for='Date_Accomplished_ARSP'>Date_Accomplished</label> {{form.Date_Accomplished_ARSP| append_attr:"class: form-control"}}
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="form-group">
                              <label class='form-control-label' for='ars_contact'>Contact Number</label> {{ form.ars_contact| append_attr:"class: form-control "}} 
                          </div>
                         
                        </div>
                     </div>
                        <div class="row">
                          <div class="col-lg-4">
                            <div class="form-group">
                              <label class='form-control-label' for='ars_email'>Email Address</label> {{form.ars_email| append_attr:"class: form-control"}}
                              
                            </div>
                          </div>
                          <div class="col-lg-8">
                            <div class="form-group">
                              <label class='form-control-label' for='ars_notes'>Notes</label> {{form.ars_notes| append_attr:"class: form-control"}}
                        </div> 
                      </div> 
                    </div> 
                  </div> 
                     </div> 
                    </div> 
                </div>  
              </div>
              </div> 
               <!--tabcontent 2-->
            </div> <!--card body-->
        
        </form> <!---end of form with post method-->  
      </div> <!--card-->
        <div class="col-12 text-left">
          <div class="col-6">
          <!-- <button class="btn btn-sm btn-primary" onclick="topFunction()" id="myBtn" title="Go to top">Go to Top</button> -->
           <!-- <a href="#mytop" class="btn btn-sm btn-primary">Back to top</a> -->
           <button type="button" onclick="topFunction()" id="myBtn" title="gototop" class="btn btn-sm btn-primary"> Back to top</button>
          </div>
        </div>
      </div>
    </div>
    </div>
    {% include "includes/footer.html" %}
  </div>
 
{% endblock content %}

<!-- Specific JS goes HERE --> 
{% block javascripts %}

<script>
  // Get the button (back to top button)
  let mybutton = document.getElementById("myBtn");
  
  // When the user scrolls down 50px from the top of the document, show the button
  window.onscroll = function() {scrollFunction()};
  
  function scrollFunction() {
    if (document.body.scrollTop > 50 || document.documentElement.scrollTop > 50) {
      mybutton.style.display = "block";
    } else {
      mybutton.style.display = "none";
    }
  }
  
  // When the user clicks on the button, scroll to the top of the document
  function topFunction() {
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
  }
  
</script>


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
  // This will generate the Clinic Code, Clinic Name, Egasp ID, and cliniccodegen
  $(document).ready(function() {
    $('#id_PTIDCode').change(function() {
      const ptidCode = $(this).val();
      const idNumber = $('#id_ID_Number').val(); // Assuming the ID number input has this ID
      if (ptidCode) {
        $.ajax({
          url: "{% url 'get_clinic_code' %}",  // Define this URL in your urls.py
          data: {'ptid_code': ptidCode},
          dataType: 'json',
          success: function(data) {
            $('#id_Clinic_Code').val(data.clinic_code);  // Update the Clinic_Code field
            $('#id_Clinic').val(data.clinic_name);  // Update the Clinic field with the correct key
            generateEgaspId(ptidCode, idNumber); // Generate Egasp ID & clinic code with current values
            generateClinicCodeGen(data.clinic_code, idNumber); // Generate cliniccodegen
          }
        });
      } else {
        $('#id_Clinic_Code').val('');  // Clear Clinic_Code if no PTIDCode is selected
        $('#id_Clinic').val('');  // Clear Clinic if no PTIDCode is selected
        $('#id_Egasp_Id').val(''); // Clear Egasp ID if no PTIDCode is selected
        $('#id_cliniccodegen').val(''); // Clear cliniccodegen if no PTIDCode is selected
      }
    });
  
    // Listen for changes in the ID number field to update Egasp ID
    $('#id_ID_Number').on('input', function() {
      const idNumber = $(this).val();
      const ptidCode = $('#id_PTIDCode').val(); // Get the currently selected PTIDCode
      const clinicCode = $('#id_Clinic_Code').val(); // Get the currently selected Clinic_Code
      generateEgaspId(ptidCode, idNumber); // Pass the ptidCode and idNumber
      generateClinicCodeGen(clinicCode, idNumber); // Generate cliniccodegen
    });
  
    function generateEgaspId(ptidCode, idNumber) {
      if (ptidCode && idNumber) {
        $('#id_Egasp_Id').val(ptidCode + idNumber); // Generate Egasp ID in the format PTIDCode-IDNumber
      } else {
        $('#id_Egasp_Id').val(''); // Clear Egasp ID if either value is missing
      }
    }
  
    function generateClinicCodeGen(clinicCode, idNumber) {
      if (clinicCode && idNumber) {
        $('#id_ClinicCodeGen').val(clinicCode + '-' + idNumber); // Set cliniccodegen in the format ClinicCode-IDNumber
      } else {
        $('#id_ClinicCodeGen').val(''); // Clear cliniccodegen if either value is missing
      }
    }
  
    // Update ars_contact and ars_email when Clinic_Staff is selected
    $('#id_Laboratory_Staff').change(function() {
      const labStaffId = $(this).val();
      if (labStaffId) {
        $.ajax({
          url: "{% url 'get_ars_staff_details' %}",  // Define this URL in your urls.py
          data: {'lab_staff_id': labStaffId},
          dataType: 'json',
          success: function(data) {
            $('#id_ars_contact').val(data.LabStaff_Telnum);  // Update the ars_contact field
            $('#id_ars_email').val(data.LabStaff_EmailAdd);  // Update the ars_email field
          }
        });
      } else {
        $('#id_ars_contact').val('');  // Clear ars_contact if no Clinic_Staff is selected
        $('#id_ars_email').val('');  // Clear ars_email if no Clinic_Staff is selected
      }
    });
    
  });
  </script>

<!-- <script>
  document.getElementById('id_PermAdd_same_CurrAdd').addEventListener('change', function () {
      const isChecked = this.checked;

      const currentProvince = document.getElementById('id_Current_Province').value;
      const currentCity = document.getElementById('id_Current_City').value;

      const permanentProvinceField = document.getElementById('id_Permanent_Province');
      const permanentCityField = document.getElementById('id_Permanent_City');

      if (isChecked) {
          permanentProvinceField.value = currentProvince;
          permanentCityField.value = currentCity;
      } else {
          permanentProvinceField.value = '';
          permanentCityField.value = '';
      }
  });
</script> -->

<script>
  function calculateAge() {
      const birthInput = document.getElementById('id_Birthdate').value;
      const consultInput = document.getElementById('id_Consult_Date').value;

      const ageField = document.getElementById('id_Age');

      // Ensure both fields are filled
      if (!birthInput || !consultInput) {
          ageField.value = '';
          return;
      }

      // Parse the input dates explicitly
      const birthdate = new Date(birthInput);
      const consultDate = new Date(consultInput);

      // Validate the parsed dates
      if (isNaN(birthdate.getTime()) || isNaN(consultDate.getTime())) {
          ageField.value = '';
          return;
      }

      if (consultDate < birthdate) {
          ageField.value = 'Invalid Dates';
          return;
      }

      // Calculate the age
      let age = consultDate.getFullYear() - birthdate.getFullYear();
      const m = consultDate.getMonth() - birthdate.getMonth();
      if (m < 0 || (m === 0 && consultDate.getDate() < birthdate.getDate())) {
          age--;
      }

      ageField.value = age;
  }

  // Attach event listeners to the date fields
  document.getElementById('id_Birthdate').addEventListener('change', calculateAge);
  document.getElementById('id_Consult_Date').addEventListener('change', calculateAge);
</script>




  

{% endblock javascripts %}

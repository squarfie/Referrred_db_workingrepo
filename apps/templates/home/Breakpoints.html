{% extends 'layouts/base.html' %}
{% load static %} 
{% load widget_tweaks %}

{% block title %}Add / Update Breakpoints{% endblock title %}

{% block stylesheets %}
<style>

.breakpoints-header {
  background: linear-gradient(135deg, #1a7a8e 0%, #2d9cad 50%, #45b5c6 100%);
  min-height: 180px;
  position: relative;
  overflow: hidden;
}

.breakpoints-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-image: radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%), 
                    radial-gradient(circle at 80% 30%, rgba(255,255,255,0.08) 0%, transparent 50%);
  opacity: 0.6;
}

.form-card {
  border-top: 4px solid #2d9cad;
  box-shadow: 0 4px 12px rgba(29, 156, 173, 0.15);
}

.form-control-label {
  color: #1a7a8e;
  font-weight: 600;
  font-size: 0.875rem;
}

.form-control {
  border: 1px solid #d1e8ed;
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: #2d9cad;
  box-shadow: 0 0 0 0.2rem rgba(45, 156, 173, 0.15);
}

.section-divider {
  background: linear-gradient(135deg, #e8f5f7 0%, #d1e8ed 100%);
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
  margin: 1.5rem 0 1rem 0;
  border-left: 4px solid #2d9cad;
}

.checkbox-container {
  background: linear-gradient(135deg, #f8fcfd 0%, #e8f5f7 100%);
  padding: 1.5rem;
  border-radius: 0.5rem;
  border: 1px solid #d1e8ed;
}

.checkbox-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.checkbox-wrapper input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: #2d9cad;
}

.btn-primary {
  background: linear-gradient(135deg, #1a7a8e 0%, #2d9cad 100%);
  border: none;
  box-shadow: 0 2px 8px rgba(29, 156, 173, 0.25);
  transition: all 0.3s ease;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #155f6f 0%, #247d8f 100%);
  box-shadow: 0 4px 12px rgba(29, 156, 173, 0.35);
  transform: translateY(-1px);
}

.btn-success {
  background: linear-gradient(135deg, #7ec97e 0%, #5fb85f 100%);
  border: none;
  box-shadow: 0 2px 8px rgba(126, 201, 126, 0.25);
}

.btn-success:hover {
  background: linear-gradient(135deg, #6ab86a 0%, #4da04d 100%);
  transform: translateY(-1px);
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
  border: none;
}

.btn-danger {
  background: linear-gradient(135deg, #d97c7c 0%, #c24b4b 100%);
  border: none;
}

.breakpoint-inputs {
  background: linear-gradient(135deg, #f8fcfd 0%, #ffffff 100%);
  padding: 1.5rem;
  border-radius: 0.5rem;
  border: 2px solid #d1e8ed;
}

.breakpoint-inputs .col-md-3 {
  position: relative;
}

.breakpoint-inputs .form-control {
  text-align: center;
  font-weight: 600;
  font-size: 1.1rem;
}

.breakpoint-label-r { color: #d97c7c; }
.breakpoint-label-i { color: #e6c86b; }
.breakpoint-label-sdd { color: #7eb8d4; }
.breakpoint-label-s { color: #7ec97e; }
</style>
{% endblock stylesheets %}

{% block content %}

<!-- Header Section -->
<div class="breakpoints-header pb-6" style="min-height: 180px; background-size: cover; background-image: url(/static/assets/img/theme/microbial.jpg); background-position: bottom right;">
  <span class="mask bg-gradient-default opacity-5"></span>
  <div class="container-fluid" style="position: relative; z-index: 1;">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-8">
          <h6 class="h2 text-white d-inline-block mb-0">
            <i class="fas fa-flask mr-2"></i>
            {% if editing %}Edit{% else %}Add{% endif %} Breakpoint
          </h6>
          <p class="text-white mt-2 mb-0 opacity-8">
            <strong><small>Configure antimicrobial susceptibility testing breakpoints</small></strong>
          </p>
        </div>
        <div class="col-lg-4 text-right">
          <a href="{% url 'breakpoints_view' %}" class="btn btn-sm btn-neutral">
            <i class="fas fa-table mr-1"></i>View All
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container-fluid mt--6">
  <div class="card shadow form-card">
    <div class="card-body p-4">
      {% if form %}
      <form method="POST" action="{% if editing %}{% url 'edit_breakpoints' pk=form.instance.pk %}{% else %}{% url 'add_breakpoints' %}{% endif %}" id="breakpointsform">
        {% csrf_token %}
        
        <!-- Upload Button -->
        <div class="mb-4">
          <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#UploadModal">
            <i class="fas fa-file-upload mr-2"></i>Upload Breakpoints CSV/Excel
          </button>
        </div>

        <!-- Checkbox Section -->
        <div class="checkbox-container mb-4">
          <div class="row">
            <div class="col-md-4">
              <div class="checkbox-wrapper">
                <label class="form-control-label mb-2" for="Disk_Abx">
                  <i class="fas fa-circle mr-1" style="color: #2d9cad;"></i>Disk Diffusion Method
                </label>
                <input id="Disk_Abx" type="checkbox" name="Disk_Abx" {% if form.Disk_Abx.value %}checked{% endif %} />
              </div>
            </div>
          </div>
        </div>

        <!-- Guidelines and Test Method -->
        <div class="section-divider">
          <h5 class="mb-0" style="color: #1a7a8e;">
            <i class="fas fa-book-medical mr-2"></i>Guidelines & Methods
          </h5>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Guidelines">
                <i class="fas fa-clipboard-list mr-1"></i>Guidelines
              </label>
              <select name="Guidelines" class="form-control">
                <option value="" disabled selected>Select Guidelines</option>
                {% for value, label in form.fields.Guidelines.choices %}
                <option value="{{ value }}" {% if breakpoint.Guidelines == value %}selected{% endif %}>
                  {{ label }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Test_Method">
                <i class="fas fa-vial mr-1"></i>Test Method
              </label>
              <select name="Test_Method" class="form-control">
                <option value="" disabled selected>Select Test Method</option>
                {% for value, label in form.fields.Test_Method.choices %}
                <option value="{{ value }}" {% if form.Test_Method.value == value %}selected{% endif %}>
                  {{ label }}
                </option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Antibiotic Information -->
        <div class="section-divider">
          <h5 class="mb-0" style="color: #1a7a8e;">
            <i class="fas fa-pills mr-2"></i>Antibiotic Information
          </h5>
        </div>
        <div class="row">
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Antibiotic">
                <i class="fas fa-capsules mr-1"></i>Antibiotic Name
              </label>
              <input id="Antibiotic" class="form-control" value="{{breakpoint.Antibiotic}}" type="text" name="Antibiotic" placeholder="e.g. Cefixime"/>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="form-control-label" for="Abx_code">
                <i class="fas fa-code mr-1"></i>Antibiotic Code
              </label>
              <input id="Abx_code" class="form-control" value="{{breakpoint.Abx_code}}" type="text" name="Abx_code" placeholder="e.g. CFM"/>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label" for="Potency">
                <i class="fas fa-weight mr-1"></i>Potency
              </label>
              <input id="Potency" class="form-control" value="{{breakpoint.Potency}}" type="text" name="Potency" placeholder="e.g. 30Âµg"/>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label" for="Whonet_Abx">
                <i class="fas fa-globe mr-1"></i>WHONET Code
              </label>
              <input id="Whonet_Abx" class="form-control" value="{{breakpoint.Whonet_Abx}}" type="text" name="Whonet_Abx" placeholder="e.g. CFM_ND30"/>
            </div>
          </div>
          <div class="col-md-4">
            <div class="form-group">
              <label class="form-control-label" for="Tier">
                <i class="fas fa-layer-group mr-1"></i>Tier
              </label>
              <input id="Tier" class="form-control" value="{{breakpoint.Tier}}" type="text" name="Tier"/>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-12">
            <div class="form-group">
              <label class="form-control-label" for="Alert_val">
                <i class="fas fa-bell mr-1"></i>Alert Value
              </label>
              <input id="Alert_val" class="form-control" value="{{breakpoint.Alert_val}}" type="text" name="Alert_val"/>
            </div>
          </div>
        </div>

        <!-- Breakpoint Values -->
        <div class="section-divider">
          <h5 class="mb-0" style="color: #1a7a8e;">
            <i class="fas fa-chart-line mr-2"></i>Breakpoint Values
          </h5>
        </div>
        <div class="breakpoint-inputs">
          <div class="row text-center">
            <div class="col-md-3">
              <label class="form-control-label breakpoint-label-r" for="R_val">
                <i class="fas fa-times-circle mr-1"></i>Resistant (â¤)
              </label>
              <input id="R_val" class="form-control" value="{{breakpoint.R_val}}" type="text" name="R_val" style="border-color: #d97c7c;"/>
            </div>
            <div class="col-md-3">
              <label class="form-control-label breakpoint-label-i" for="I_val">
                <i class="fas fa-minus-circle mr-1"></i>Intermediate
              </label>
              <input id="I_val" class="form-control" value="{{breakpoint.I_val}}" type="text" name="I_val" style="border-color: #e6c86b;"/>
            </div>
            <div class="col-md-3">
              <label class="form-control-label breakpoint-label-sdd" for="SDD_val">
                <i class="fas fa-adjust mr-1"></i>SDD
              </label>
              <input id="SDD_val" class="form-control" value="{{breakpoint.SDD_val}}" type="text" name="SDD_val" style="border-color: #7eb8d4;"/>
            </div>
            <div class="col-md-3">
              <label class="form-control-label breakpoint-label-s" for="S_val">
                <i class="fas fa-check-circle mr-1"></i>Susceptible (â¥)
              </label>
              <input id="S_val" class="form-control" value="{{breakpoint.S_val}}" type="text" name="S_val" style="border-color: #7ec97e;"/>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary btn-lg px-5">
            <i class="fas fa-save mr-2"></i>{% if editing %}Update{% else %}Add{% endif %} Breakpoint
          </button>
          <button type="button" class="btn btn-success btn-lg px-4" onclick="refresh()">
            <i class="fas fa-eraser mr-2"></i>Clear Form
          </button>
          <button type="button" class="btn btn-secondary btn-lg px-4" onclick="history.back()">
            <i class="fas fa-arrow-left mr-2"></i>Back
          </button>
        </div>
      </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="UploadModal" tabindex="-1" role="dialog" aria-labelledby="UploadModalLabel" aria-hidden="true">
  <form method="POST" action="{% url 'upload_breakpoints' %}" autocomplete="on" enctype="multipart/form-data" onsubmit="return confirmOverwrite();" id="uploadbreakpointform">
    {% csrf_token %}
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content" style="border-top: 4px solid #2d9cad;">
        <div class="modal-header" style="background: linear-gradient(135deg, #e8f5f7 0%, #d1e8ed 100%); border-bottom: 2px solid #d1e8ed;">
          <h5 class="modal-title" style="color: #1a7a8e; font-weight: 600;">
            <i class="fas fa-file-upload mr-2"></i>Upload Breakpoints
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="alert" style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-left: 4px solid #e6c86b; color: #856404;">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Warning:</strong> Uploading will replace all existing breakpoints.
          </div>
          <div class="form-group">
            <label for="File_uploadBP" class="form-control-label">
              <i class="fas fa-file-csv mr-1"></i>Select CSV/Excel File
            </label>
            {{ upload_form.File_uploadBP }}
          </div>
        </div>
        <div class="modal-footer" style="background: #f8fcfd;">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            <i class="fas fa-times mr-1"></i>Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-upload mr-1"></i>Upload File
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<script>
function refresh() {
  if (confirm('Are you sure you want to clear all form fields?')) {
    document.getElementById("breakpointsform").reset();
  }
}

function confirmOverwrite() {
  return confirm("â ï¸ WARNING: Uploading will replace all existing breakpoints. Are you sure you want to proceed?");
}
</script>

{% endblock content %}